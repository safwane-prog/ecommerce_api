{% extends 'core/base.html' %}
{% load static %}
{% block title %}Product Catalog - Shop{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }
    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
        color: #1a1a1a;
    }

    .shop-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 24px;
    }
    .register-btn:hover{
        background-color: #10b981 !important;
    }
    .breadcrumb {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        padding: 16px 24px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        border: 1px solid rgba(255,255,255,0.2);
    }
    .breadcrumb ol {
        display: flex;
        list-style: none;
        align-items: center;
        gap: 12px;
    }
    .breadcrumb ol li a {
        text-decoration: none;
        color: #64748b;
        font-weight: 500;
        transition: all 0.3s ease;
        padding: 4px 8px;
        border-radius: 6px;
    }
    .breadcrumb ol li a:hover {
        color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
    }
    .breadcrumb ol li.active {
        color: #3b82f6;
        font-weight: 600;
    }

    .filter-toggle-btn {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 20px;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        transition: all 0.3s ease;
    }
    .filter-toggle-btn:hover {
        background: #2563eb;
        transform: translateY(-2px);
    }

    .shop-layout {
        display: grid;
        grid-template-columns: 320px 1fr;
        gap: 32px;
        transition: all 0.3s ease;
    }
    .shop-layout.filters-hidden {
        grid-template-columns: 0 1fr;
    }
    .shop-layout.filters-hidden .filters-sidebar {
        transform: translateX(-100%);
        opacity: 0;
        visibility: hidden;
    }
    @media (max-width: 1024px) {
        .shop-layout {
            grid-template-columns: 1fr;
        }
        .filters-sidebar {
            order: 2;
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80vh;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -8px 32px rgba(0,0,0,0.1);
        }
        .filters-sidebar.active {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }
        .shop-layout.filters-hidden .filters-sidebar {
            transform: translateY(100%);
        }
    }

    .filters-sidebar {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 28px;
        height: fit-content;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        border: 1px solid rgba(255,255,255,0.2);
        position: sticky;
        top: 24px;
        transition: transform 0.3s ease, opacity 0.3s ease, visibility 0.3s ease;
    }
    .filters-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 28px;
        padding-bottom: 16px;
        border-bottom: 2px solid #f1f5f9;
    }
    .filters-header h3 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1e293b;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .filters-toggle {
        background: #f8fafc;
        border: none;
        font-size: 1.2rem;
        color: #64748b;
        cursor: pointer;
        transition: all 0.3s ease;
        padding: 8px;
        border-radius: 8px;
    }
    .filters-toggle:hover {
        color: #3b82f6;
        background: rgba(59, 130, 246, 0.1);
    }

    .filter-section {
        margin-bottom: 20px;
        border-bottom: 1px solid #f1f5f9;
        padding-bottom: 20px;
    }
    .filter-section:last-of-type {
        border-bottom: none;
    }
    .filter-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
        padding: 8px 0;
        transition: all 0.3s ease;
        border-radius: 8px;
        margin: -8px 0;
        padding: 8px;
    }
    .filter-header:hover {
        background: rgba(59, 130, 246, 0.1);
    }
    .filter-header h4 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #374151;
    }
    .toggle-icon {
        transition: transform 0.3s ease;
        color: #64748b;
    }
    .filter-content {
        max-height: 0;
        overflow: hidden;
        transition: all 0.3s ease;
        opacity: 0;
    }
    .filter-content.active {
        max-height: 350px;
        padding-top: 12px;
        opacity: 1;
    }
    .size-options, .color-options, .category-options {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .filter-option {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 8px;
        padding: 8px;
        border-radius: 8px;
        transition: all 0.2s ease;
    }
    .filter-option:hover {
        background: rgba(59, 130, 246, 0.05);
    }
    .filter-option input[type="checkbox"] {
        width: 18px;
        height: 18px;
        accent-color: #3b82f6;
        cursor: pointer;
    }
    .filter-option label {
        cursor: pointer;
        font-weight: 500;
        color: #374151;
        transition: color 0.3s ease;
        flex: 1;
    }
    .filter-option:hover label {
        color: #3b82f6;
    }

    .range-slider {
        padding: 16px 0;
    }
    .range-values {
        display: flex;
        justify-content: space-between;
        margin-bottom: 16px;
        font-weight: 700;
        color: #3b82f6;
        font-size: 0.95rem;
    }
    .range-input {
        width: 100%;
        height: 8px;
        border-radius: 4px;
        background: linear-gradient(to right, #3b82f6 0%, #e2e8f0 0%);
        outline: none;
        appearance: none;
        cursor: pointer;
    }
    .range-input::-webkit-slider-thumb {
        appearance: none;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        background: #3b82f6;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        transition: all 0.2s ease;
    }
    .range-input::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 12px rgba(59, 130, 246, 0.4);
    }

    .filter-actions {
        display: flex;
        gap: 12px;
        margin-top: 28px;
    }
    .apply-filters, .reset-filters {
        flex: 1;
        padding: 10px;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
    }
    .apply-filters {
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
    }
    .apply-filters:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
    }
    .reset-filters {
        background: #f8fafc;
        color: #64748b;
        border: 2px solid #e2e8f0;
    }
    .reset-filters:hover {
        background: #f1f5f9;
        transform: translateY(-2px);
    }

    .products-grid {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 32px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        border: 1px solid rgba(255,255,255,0.2);
    }
    .products-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 32px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f1f5f9;
        flex-wrap: wrap;
        gap: 16px;
    }
    .products-count {
        font-weight: 600;
        color: #64748b;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .products-count i {
        color: #3b82f6;
    }
    .sort-options {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .sort-options label {
        font-weight: 600;
        color: #64748b;
    }
    .sort-options select {
        padding: 10px 16px;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
        min-width: 200px;
    }
    .sort-options select:focus {
        outline: none;
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .products-container {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 28px;
        margin-bottom: 20px;
    }

    .loading-skeleton {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
        border-radius: 15px;
        height: 400px;
    }
    @keyframes loading {
        0% { background-position: 200% 0; }
        100% { background-position: -200% 0; }
    }

    .product-card_context {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        border: 1px solid rgba(255,255,255,0.2);
    }
    .product-card_context:hover {
        transform: translateY(-8px) scale(1.02);
        box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    .product-image {
        position: relative;
        width: 100%;
        height: 300px;
        overflow: hidden;
        background: linear-gradient(135deg, #f8fafc, #e2e8f0);
    }
    .product-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: all 0.4s ease;
        cursor: pointer;
    }
    .product-card_context:hover .product-image img {
        transform: scale(1.1);
    }
    .wishlist-btn {
        position: absolute;
        top: 16px;
        right: 16px;
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(10px);
        border: none;
        border-radius: 50%;
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        color: #64748b;
        z-index: 10;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .wishlist-btn:hover {
        background: white;
        color: #ef4444;
        transform: scale(1.1);
    }
    .wishlist-btn.active {
        color: #ef4444;
        background: rgba(239, 68, 68, 0.1);
    }
    .discount-badge {
        position: absolute;
        top: 16px;
        left: 16px;
        background: #ef4444;
        color: white;
        padding: 2px 6px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: 600;
        z-index: 10;
    }
    .product-details {
        padding: 20px;
    }
    .product-title {
        font-size: 1.2rem;
        font-weight: 600;
        margin-bottom: 12px;
        color: #1e293b;
        line-height: 1.3;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .product-description {
        font-size: 0.9rem;
        color: #64748b;
        margin-bottom: 12px;
        display: -webkit-box;
        -webkit-line-clamp: 1;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
    .price-container {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 16px;
    }
    .current-price {
        font-size: 1.2rem;
        font-weight: 800;
        color: #3b82f6;
    }
    .old-price {
        font-size: 1rem;
        color: #64748b;
        text-decoration: line-through;
    }
    .addtocart {
        display: flex;
        gap: 12px;
        padding: 0 20px 20px;
    }
    .add-to-cart-btn {
        flex: 1;
        background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        color: white;
        border: none;
        padding: 12px;
        border-radius: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 0.9rem;
    }
    .add-to-cart-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(59, 130, 246, 0.3);
    }
    .add-to-cart-btn:disabled {
        background: #10b981;
        cursor: not-allowed;
        transform: none;
    }
    .product-info-btn {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        width: 48px;
        height: 48px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #64748b;
        transition: all 0.3s ease;
    }
    .product-info-btn:hover {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
        transform: scale(1.05);
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 12px;
        margin-top: 48px;
        flex-wrap: wrap;
    }
    .pagination-button {
        background: white;
        border: 2px solid #e2e8f0;
        padding: 12px 20px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 100px;
        justify-content: center;
    }
    .pagination-button:hover:not(:disabled) {
        border-color: #3b82f6;
        color: #3b82f6;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.2);
    }
    .pagination-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    .page-numbers {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }
    .page-number {
        background: white;
        border: 2px solid #e2e8f0;
        padding: 12px 16px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        min-width: 44px;
        text-align: center;
    }
    .page-number:hover {
        border-color: #3b82f6;
        color: #3b82f6;
        transform: translateY(-2px);
    }
    .page-number.active {
        background: #3b82f6;
        color: white;
        border-color: #3b82f6;
        box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
    }

    .cart-notification {
        position: fixed;
        bottom: 24px;
        right: 24px;
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(16, 185, 129, 0.3);
        z-index: 1000;
        animation: slide-in-right 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 12px;
        backdrop-filter: blur(10px);
    }
    .cart-notification.error {
        background: linear-gradient(135deg, #ef4444, #b91c1c);
    }
    .cart-notification.fade-out {
        animation: fade-out 0.5s ease-out forwards;
    }
    @keyframes slide-in-right {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fade-out {
        from { opacity: 1; }
        to { opacity: 0; }
    }

    .empty-state {
        text-align: center;
        padding: 80px 20px;
        color: #64748b;
        grid-column: 1 / -1;
    }
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #e2e8f0;
    }
    .empty-state h3 {
        font-size: 1.5rem;
        margin-bottom: 12.learn-more-btnpx;
        color: #374151;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 2000;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background: white;
        border-radius: 16px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        text-align: center;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        position: relative;
    }
    .modal-content h3 {
        font-size: 1.5rem;
        margin-bottom: 16px;
        color: #1e293b;
    }
    .modal-content p {
        color: #64748b;
        margin-bottom: 24px;
    }
    .modal-actions {
        display: flex;
        gap: 16px;
        justify-content: center;
    }
    .modal-actions a {
        padding: 12px 24px;
        border-radius: 10px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    .modal-actions .login-btn {
        background: #3b82f6;
        color: white;
    }
    .modal-actions .login-btn:hover {
        background: #2563eb;
        transform: translateY(-2px);
    }
    .modal-actions .register-btn {
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        color: #64748b;
    }
    .modal-actions .register-btn:hover {
        background: #f1f5f9;
        transform: translateY(-2px);
    }
    .modal-close {
        position: absolute;
        top: 16px;
        right: 16px;
        background: none;
        border: none;
        font-size: 1.2rem;
        color: #64748b;
        cursor: pointer;
    }
    .modal-close:hover {
        color: #3b82f6;
    }
    .modal.active {
        display: flex;
    }

    @media (max-width: 768px) {
        .shop-container {
            padding: 16px;
        }
        .breadcrumb {
            flex-direction: column;
            gap: 16px;
        }
        .products-header {
            flex-direction: column;
            align-items: stretch;
        }
        .sort-options {
            justify-content: space-between;
        }
        .sort-options select {
            min-width: auto;
            flex: 1;
        }
        .products-container {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }
        .pagination {
            gap: 8px;
        }
        .pagination-button {
            padding: 10px 16px;
            min-width: 80px;
        }
    }
    @media (max-width: 480px) {
        .products-container {
            grid-template-columns: 1fr;
        }
        .filters-sidebar {
            padding: 20px;
        }
        .filter-actions {
            flex-direction: column;
        }
        .shop-layout {
            gap: 20px;
        }
    }

    .mobile-filter-toggle {
        display: none;
        background: #3b82f6;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        margin-bottom: 20px;
        width: 100%;
        transition: all 0.3s ease;
    }
    @media (max-width: 1024px) {
        .mobile-filter-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .filters-sidebar {
            display: none;
        }
        .filters-sidebar.active {
            display: block;
        }
        .filter-toggle-btn {
            display: none !important;
        }
    }

    .loader-container {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(5px);
        z-index: 1000;
        justify-content: center;
        align-items: center;
    }
    .loader {
        width: 60px;
        height: 60px;
        border: 6px solid #e2e8f0;
        border-top: 6px solid #3b82f6;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .loader-container.active {
        display: flex;
    }
</style>
<div class="loader-container" id="mainLoader">
    <div class="loader"></div>
</div>
<div class="modal" id="authModal">
    <div class="modal-content">
        <button class="modal-close" onclick="closeAuthModal()">
            <i class="fa-solid fa-times"></i>
        </button>
        <h3>Please Sign In</h3>
        <p>You need to be logged in to add items to your cart.</p>
        <div class="modal-actions">
            <a href="{% url 'loginpage' %}" class="login-btn">Login</a>
            <a href="{% url 'registerpage' %}" class="register-btn">Register</a>
        </div>
    </div>
</div>
<section class="shop-container">
    <nav class="breadcrumb">
        <ol>
            <li><a href="{% url 'home' %}"><i class="fa-solid fa-home"></i> Home</a></li>
            <li><i class="fa-solid fa-chevron-right"></i></li>
            <li class="active">Shop</li>
        </ol>
        <div class="breadcrumb-actions">
            <button class="mobile-filter-toggle" onclick="toggleMobileFilters()">
                <i class="fa-solid fa-filter"></i>
                Filters
            </button>
        </div>
    </nav>

    <button class="filter-toggle-btn" onclick="toggleFilters()">
        <i class="fa-solid fa-filter"></i>
        <span id="filterToggleText">Hide Filters</span>
    </button>

    <div class="shop-layout" id="shopLayout">
        <aside class="filters-sidebar" id="filtersSidebar">
            <div class="filters-header">
                <h3>
                    <i class="fa-solid fa-sliders"></i>
                    Filters
                </h3>
                <button style="display: none;" class="filters-toggle" onclick="toggleMobileFilters()">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <div class="filter-section">
                <div class="filter-header" data-toggle="category">
                    <h4>Category</h4>
                    <i class="toggle-icon fa-solid fa-chevron-up"></i>
                </div>
                <div class="filter-content active" id="category">
                    <div class="category-options"></div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-header" data-toggle="price">
                    <h4>Price Range</h4>
                    <i class="toggle-icon fa-solid fa-chevron-down"></i>
                </div>
                <div class="filter-content" id="price">
                    <div class="range-slider">
                        <div class="range-values">
                            <span>$<span id="minPriceDisplay">0</span></span>
                            <span>$<span id="maxPriceDisplay">1000+</span></span>
                        </div>
                        <input type="range" class="range-input" id="priceRange" min="0" max="1000" step="10" value="1000">
                    </div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-header" data-toggle="color">
                    <h4>Color</h4>
                    <i class="toggle-icon fa-solid fa-chevron-down"></i>
                </div>
                <div class="filter-content" id="color">
                    <div class="color-options"></div>
                </div>
            </div>

            <div class="filter-section">
                <div class="filter-header" data-toggle="size">
                    <h4>Size</h4>
                    <i class="toggle-icon fa-solid fa-chevron-down"></i>
                </div>
                <div class="filter-content" id="size">
                    <div class="size-options"></div>
                </div>
            </div>

            <div class="filter-actions">
                <button class="apply-filters">
                    <i class="fa-solid fa-check"></i>
                    Apply 
                </button>
                <button class="reset-filters">
                    <i class="fa-solid fa-rotate-left"></i>
                    Reset All
                </button>
            </div>
        </aside>

        <main class="products-grid">
            <div class="products-header">
                <div class="products-count">
                    <i class="fa-solid fa-boxes-stacked"></i>
                    Showing <span id="productsCount">0</span> products
                </div>
                <div class="sort-options">
                    <label for="sortBy">Sort by:</label>
                    <select id="sortBy">
                        <option value="">Default</option>
                        <option value="asc">Price: Low to High</option>
                        <option value="desc">Price: High to Low</option>
                        <option value="name">Name: A to Z</option>
                        <option value="newest">Newest First</option>
                    </select>
                </div>
            </div>
            
            <div id="loadingContainer" class="products-container" style="display: none;">
                <div class="loading-skeleton"></div>
                <div class="loading-skeleton"></div>
                <div class="loading-skeleton"></div>
                <div class="loading-skeleton"></div>
            </div>
            
            <div id="productContainer" class="products-container"></div>
            
            <div class="pagination">
                <button class="pagination-button prev" disabled>
                    <i class="fa-solid fa-arrow-left"></i> Previous
                </button>
                <div class="page-numbers" id="paginationContainer"></div>
                <button class="pagination-button next">
                    Next <i class="fa-solid fa-arrow-right"></i>
                </button>
            </div>
        </main>
    </div>
</section>
<script>
    // Variables
    let products = [];
    let currentPage = 1;
    let itemsPerPage = window.innerWidth > 1024 ? 12 : 12;
    let isLoading = false;
    let wishlistItems = JSON.parse(localStorage.getItem('wishlistItems')) || [];
    let pendingFilters = null;
    let isLoggedIn = false;

    // Check login status
    async function checkLoginStatus() {
        try {
            const response = await fetch("/api/users/status/", {
                method: "GET",
                credentials: "include"
            });
            isLoggedIn = response.ok;
            return isLoggedIn;
        } catch (error) {
            console.error("Error checking login status:", error);
            return false;
        }
    }

    // Update itemsPerPage based on filter visibility and screen size
    function updateItemsPerPage() {
        const shopLayout = document.getElementById('shopLayout');
        const isDesktop = window.innerWidth > 1024;
        itemsPerPage = isDesktop && shopLayout.classList.contains('filters-hidden') ? 16 : 12;
    }

    // Show loading state
    function showLoading() {
        document.getElementById('mainLoader').classList.add('active');
        document.getElementById('productContainer').style.display = 'none';
        document.getElementById('loadingContainer').style.display = 'grid';
    }

    // Hide loading state
    function hideLoading() {
        document.getElementById('mainLoader').classList.remove('active');
        document.getElementById('productContainer').style.display = 'grid';
        document.getElementById('loadingContainer').style.display = 'none';
    }

    // Toggle filters visibility
    function toggleFilters() {
        const shopLayout = document.getElementById('shopLayout');
        const filterToggleText = document.getElementById('filterToggleText');
        shopLayout.classList.toggle('filters-hidden');
        filterToggleText.textContent = shopLayout.classList.contains('filters-hidden') ? 'Show Filters' : 'Hide Filters';
        updateItemsPerPage();
        renderProducts();
        setupPagination();
    }

    // Mobile filter toggle
    function toggleMobileFilters() {
        const sidebar = document.getElementById('filtersSidebar');
        sidebar.classList.toggle('active');
    }

    // Show notification
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `cart-notification ${type}`;
        notification.innerHTML = `
            <i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-triangle'}"></i>
            ${message}
        `;
        document.body.appendChild(notification);
        setTimeout(() => {
            notification.classList.add('fade-out');
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    }

    // Show auth modal
    function showAuthModal() {
        document.getElementById('authModal').classList.add('active');
    }

    // Close auth modal
    function closeAuthModal() {
        document.getElementById('authModal').classList.remove('active');
    }

    // Fetch Filters
    async function loadFilters() {
        try {
            const [colorsRes, sizesRes, categoriesRes] = await Promise.all([
                fetch('/api/get_colors/'),
                fetch('/api/get_sizes/'),
                fetch('/api/get_category_products/')
            ]);

            if (!colorsRes.ok || !sizesRes.ok || !categoriesRes.ok) {
                throw new Error('Failed to fetch filter data');
            }

            const [colors, sizes, categories] = await Promise.all([
                colorsRes.json(),
                sizesRes.json(),
                categoriesRes.json()
            ]);

            document.querySelector('.color-options').innerHTML = colors.map(c => `
                <div class="filter-option">
                    <input type="checkbox" id="color-${c.id}" value="${c.id}">
                    <label for="color-${c.id}">${c.color}</label>
                </div>
            `).join('');

            document.querySelector('.size-options').innerHTML = sizes.map(s => `
                <div class="filter-option">
                    <input type="checkbox" id="size-${s.id}" value="${s.id}">
                    <label for="size-${s.id}">${s.size}</label>
                </div>
            `).join('');

            document.querySelector('.category-options').innerHTML = categories.map(cat => `
                <div class="filter-option">
                    <input type="checkbox" id="category-${cat.id}" value="${cat.id}">
                    <label for="category-${cat.id}">${cat.category}</label>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error loading filters:', error);
            showNotification('Error loading filters', 'error');
        }
    }

    // Load Products
    async function loadProducts() {
        if (isLoading) return;
        isLoading = true;
        showLoading();

        try {
            const urlParams = new URLSearchParams(window.location.search);
            const categoryId = urlParams.get('category');
            const apiUrl = categoryId ? `/api/products/?category=${categoryId}` : '/api/products/';

            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error('Network response was not ok');

            products = await response.json();

            if (products.length === 0) {
                showEmptyState('No products found for this category.');
                return;
            }

            updateItemsPerPage();
            renderProducts();
            setupPagination();
            updateProductsCount();
        } catch (error) {
            console.error('Error loading products:', error);
            showEmptyState('Failed to load products. Please try again.');
            showNotification('Failed to load products', 'error');
        } finally {
            isLoading = false;
            hideLoading();
        }
    }

    // Show empty state
    function showEmptyState(message = 'No products found matching your criteria.') {
        document.getElementById('productContainer').innerHTML = `
            <div class="empty-state">
                <i class="fa-solid fa-box-open"></i>
                <h3>No Products Found</h3>
                <p>${message}</p>
            </div>
        `;
    }

    // Get Filters
    function getFilters() {
        const colorCheckboxes = document.querySelectorAll('.color-options input:checked');
        const sizeCheckboxes = document.querySelectorAll('.size-options input:checked');
        const categoryCheckboxes = document.querySelectorAll('.category-options input:checked');
        const searchInput = document.getElementById('searchInput');

        return {
            colors: Array.from(colorCheckboxes).map(cb => ({ value: cb.value, checked: cb.checked })),
            sizes: Array.from(sizeCheckboxes).map(cb => ({ value: cb.value, checked: cb.checked })),
            categories: Array.from(categoryCheckboxes).map(cb => ({ value: cb.value, checked: cb.checked })),
            maxPrice: parseFloat(document.getElementById('priceRange').value),
            sort: document.getElementById('sortBy').value,
            search: searchInput ? searchInput.value.trim() : ''
        };
    }

    // Store pending filter changes
    function storePendingFilters() {
        pendingFilters = getFilters();
    }

    // Apply pending filters
    function applyPendingFilters() {
        if (!pendingFilters) return;
        currentPage = 1;
        updateItemsPerPage();
        renderProducts();
        setupPagination();
    }

    // Render Products
    function renderProducts() {
        const container = document.getElementById('productContainer');
        const filters = pendingFilters || getFilters();

        let filtered = products.filter(p => {
            const matchesColor = !filters.colors.length || (p.color && filters.colors.some(c => c.value === p.color.id.toString()));
            const matchesSize = !filters.sizes.length || (p.size && filters.sizes.some(s => s.value === p.size.id.toString()));
            const matchesCategory = !filters.categories.length || (p.Category && filters.categories.some(c => c.value === p.Category.id.toString()));
            const matchesPrice = filters.maxPrice >= 1000 || parseFloat(p.price) <= filters.maxPrice;

            if (filters.search) {
                const searchTerm = filters.search.toLowerCase();
                const matchesSearch = p.title.toLowerCase().includes(searchTerm) ||
                    (p.description && p.description.toLowerCase().includes(searchTerm));
                return matchesColor && matchesSize && matchesCategory && matchesPrice && matchesSearch;
            }

            return matchesColor && matchesSize && matchesCategory && matchesPrice;
        });

        switch (filters.sort) {
            case 'asc':
                filtered.sort((a, b) => parseFloat(a.price) - parseFloat(b.price));
                break;
            case 'desc':
                filtered.sort((a, b) => parseFloat(b.price) - parseFloat(a.price));
                break;
            case 'name':
                filtered.sort((a, b) => a.title.localeCompare(b.title));
                break;
            case 'newest':
                filtered.sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));
                break;
        }

        if (filtered.length === 0) {
            showEmptyState();
            return;
        }

        const start = (currentPage - 1) * itemsPerPage;
        const paginated = filtered.slice(start, start + itemsPerPage);

        container.innerHTML = paginated.map(product => `
            <div class="product-card_context" data-product-id="${product.id}">
                <div class="product-image">
                    <img onclick="viewDetails(${product.id})" 
                         src="${product.image_1}" 
                         alt="${product.title}" 
                         onerror="this.src='https://via.placeholder.com/300x250/f8f9fa/6c757d?text=No+Image'">
                    ${product.discount ? `<div class="discount-badge">-${product.discount}%</div>` : ''}
                    <button onclick="addToWishlist(${product.id})" 
                            title="إضافة للمفضلة" 
                            class="wishlist-btn ${wishlistItems.includes(product.id.toString()) ? 'active' : ''}" 
                            aria-label="Add to wishlist">
                        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                        </svg>
                    </button>
                </div>
                <div class="product-details">
                    <h3 class="product-title">${product.title}</h3>
                    <p class="product-description">${product.description ? product.description.substring(0, 50) + (product.description.length > 50 ? '...' : '') : 'No description available'}</p>
                    <div class="price-container">
                        <span class="current-price">$${parseFloat(product.price).toFixed(2)}</span>
                        ${product.old_price ? `<span class="old-price">$${parseFloat(product.old_price).toFixed(2)}</span>` : ''}
                    </div>
                    ${product.rating ? `
                        <div class="product-rating">
                            ${'★'.repeat(Math.floor(product.rating))}${'☆'.repeat(5 - Math.floor(product.rating))}
                            <span>(${product.rating.toFixed(1)})</span>
                        </div>
                    ` : ''}
                </div>
                <div class="addtocart">
                    <button title="Add To Cart" 
                            onclick="addToCart(${product.id})" 
                            class="add-to-cart-btn addToCart${product.id}" 
                            data-product-id="${product.id}">
                        Add To Cart <i class="fa-solid fa-cart-shopping"></i>
                    </button>
                    <button title="عرض التفاصيل" 
                            class="product-info-btn" 
                            data-product-id="${product.id}" 
                            onclick="viewDetails(${product.id})">
                        <i class="fa-solid fa-info-circle"></i>
                    </button>
                </div>
            </div>
        `).join('');

        updateProductsCount();
    }

    // Update Products Count
    function updateProductsCount() {
        const filters = pendingFilters || getFilters();
        const filtered = products.filter(p => {
            const matchesColor = !filters.colors.length || (p.color && filters.colors.some(c => c.value === p.color.id.toString()));
            const matchesSize = !filters.sizes.length || (p.size && filters.sizes.some(s => s.value === p.size.id.toString()));
            const matchesCategory = !filters.categories.length || (p.Category && filters.categories.some(c => c.value === p.Category.id.toString()));
            const matchesPrice = filters.maxPrice >= 1000 || parseFloat(p.price) <= filters.maxPrice;

            if (filters.search) {
                const searchTerm = filters.search.toLowerCase();
                const matchesSearch = p.title.toLowerCase().includes(searchTerm) ||
                    (p.description && p.description.toLowerCase().includes(searchTerm));
                return matchesColor && matchesSize && matchesCategory && matchesPrice && matchesSearch;
            }

            return matchesColor && matchesSize && matchesCategory && matchesPrice;
        });

        document.getElementById('productsCount').textContent = filtered.length;
    }

    // Setup Pagination
    function setupPagination() {
        const filters = pendingFilters || getFilters();
        const filtered = products.filter(p => {
            const matchesColor = !filters.colors.length || (p.color && filters.colors.some(c => c.value === p.color.id.toString()));
            const matchesSize = !filters.sizes.length || (p.size && filters.sizes.some(s => s.value === p.size.id.toString()));
            const matchesCategory = !filters.categories.length || (p.Category && filters.categories.some(c => c.value === p.Category.id.toString()));
            const matchesPrice = filters.maxPrice >= 1000 || parseFloat(p.price) <= filters.maxPrice;

            if (filters.search) {
                const searchTerm = filters.search.toLowerCase();
                const matchesSearch = p.title.toLowerCase().includes(searchTerm) ||
                    (p.description && p.description.toLowerCase().includes(searchTerm));
                return matchesColor && matchesSize && matchesCategory && matchesPrice && matchesSearch;
            }

            return matchesColor && matchesSize && matchesCategory && matchesPrice;
        });

        const totalPages = Math.ceil(filtered.length / itemsPerPage);
        const container = document.getElementById('paginationContainer');

        if (totalPages <= 1) {
            container.innerHTML = '';
            document.querySelector('.pagination').style.display = 'none';
            return;
        }

        document.querySelector('.pagination').style.display = 'flex';
        container.innerHTML = '';

        const maxVisiblePages = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
        let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

        if (endPage - startPage < maxVisiblePages - 1) {
            startPage = Math.max(1, endPage - maxVisiblePages + 1);
        }

        if (startPage > 1) {
            container.innerHTML += `<button class="page-number" onclick="goToPage(1)">1</button>`;
            if (startPage > 2) {
                container.innerHTML += `<span>...</span>`;
            }
        }

        for (let i = startPage; i <= endPage; i++) {
            container.innerHTML += `
                <button class="page-number${i === currentPage ? ' active' : ''}" 
                        onclick="goToPage(${i})">${i}</button>
            `;
        }

        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                container.innerHTML += `<span>...</span>`;
            }
            container.innerHTML += `
                <button class="page-number" onclick="goToPage(${totalPages})">${totalPages}</button>
            `;
        }

        document.querySelector('.pagination-button.prev').disabled = currentPage === 1;
        document.querySelector('.pagination-button.next').disabled = currentPage === totalPages;
    }

    // Go to Page
    function goToPage(page) {
        currentPage = page;
        renderProducts();
        setupPagination();
        document.querySelector('.products-grid').scrollIntoView({ 
            behavior: 'smooth', 
            block: 'start' 
        });
    }

    // Get Cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let cookie of cookies) {
                cookie = cookie.trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.split('=')[1]);
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Add to Cart
    async function addToCart(productId) {
        if (!isLoggedIn) {
            showAuthModal();
            return;
        }

        const addButton = document.querySelector(`.addToCart${productId}`);
        if (addButton.disabled) return;

        try {
            addButton.disabled = true;
            const response = await fetch('/api/add-to-cart/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'include',
                body: JSON.stringify({
                    product_id: productId,
                    quantity: 1
                })
            });

            const data = await response.json();
            if (response.ok) {
                addButton.style.background = '#10b981';
                addButton.innerHTML = `Added <i class="fa-solid fa-check"></i>`;
                addButton.style.cursor = 'not-allowed';
                showNotification('Product added to cart successfully!', 'success');
                updateCartCounter();
            } else {
                throw new Error(data.message || 'Failed to add to cart');
            }
        } catch (error) {
            console.error('Error adding to cart:', error);
            showNotification('Failed to add product to cart', 'error');
            addButton.disabled = false;
        }
    }

    // Add to Wishlist
    async function addToWishlist(productId) {
        if (!isLoggedIn) {
            showAuthModal();
            return;
        }

        const wishlistButton = document.querySelector(`[onclick="addToWishlist(${productId})"]`);
        const isAdding = !wishlistButton.classList.contains('active');

        try {
            const response = await fetch('/api/add-to-wishlist/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                credentials: 'include',
                body: JSON.stringify({
                    product_id: productId
                })
            });

            const data = await response.json();
            if (data.message === "تمت الإضافة إلى المفضلة بنجاح") {
                wishlistButton.classList.add('active');
                if (!wishlistItems.includes(productId.toString())) {
                    wishlistItems.push(productId.toString());
                    localStorage.setItem('wishlistItems', JSON.stringify(wishlistItems));
                }
                showNotification('Added to wishlist successfully!', 'success');
            } else if (data.message === "تمت الإزالة من المفضلة بنجاح") {
                wishlistButton.classList.remove('active');
                wishlistItems = wishlistItems.filter(id => id !== productId.toString());
                localStorage.setItem('wishlistItems', JSON.stringify(wishlistItems));
                showNotification('Removed from wishlist successfully!', 'success');
            } else {
                throw new Error(data.message || 'Error updating wishlist');
            }
        } catch (error) {
            console.error('Error updating wishlist:', error);
            showNotification('Error updating wishlist', 'error');
        }
    }

    // Load Wishlist
    async function loadWishlist() {
        try {
            const response = await fetch('/api/wishlist/', {
                credentials: 'include'
            });
            if (!response.ok) throw new Error('Failed to fetch wishlist');
            const data = await response.json();
            wishlistItems = data.wishlist.map(id => id.toString());
            localStorage.setItem('wishlistItems', JSON.stringify(wishlistItems));
            renderProducts();
        } catch (error) {
            console.error('Error loading wishlist:', error);
            showNotification('Error loading wishlist', 'error');
        }
    }

    // View Product Details
    function viewDetails(productId) {
        window.location.href = `/product-detail.html?id=${productId}`;
    }

    // Update Cart Counter (Placeholder)
    function updateCartCounter() {
        // Implement cart counter update logic if needed
    }

    // Debounce function
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Event Listeners
    document.addEventListener('DOMContentLoaded', async () => {
        await checkLoginStatus();
        await Promise.all([loadFilters(), loadProducts(), loadWishlist()]);

        document.querySelectorAll('.filter-header').forEach(header => {
            header.addEventListener('click', () => {
                const targetId = header.getAttribute('data-toggle');
                const content = document.getElementById(targetId);
                const icon = header.querySelector('.toggle-icon');
                content.classList.toggle('active');
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            });
        });

        const priceRange = document.getElementById('priceRange');
        if (priceRange) {
            priceRange.addEventListener('input', function() {
                document.getElementById('maxPriceDisplay').textContent = this.value >= 1000 ? '1000+' : this.value;
                storePendingFilters();
            });
        }

        const sortBy = document.getElementById('sortBy');
        if (sortBy) {
            sortBy.addEventListener('change', () => {
                storePendingFilters();
                applyPendingFilters();
            });
        }

        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', debounce(() => {
                storePendingFilters();
                applyPendingFilters();
            }, 500));
        }

        document.querySelector('.apply-filters').addEventListener('click', applyPendingFilters);

        document.querySelector('.reset-filters').addEventListener('click', () => {
            document.querySelectorAll('.color-options input, .size-options input, .category-options input')
                .forEach(cb => cb.checked = false);
            const priceRange = document.getElementById('priceRange');
            priceRange.value = priceRange.max;
            document.getElementById('maxPriceDisplay').textContent = '1000+';
            document.getElementById('sortBy').value = '';
            if (searchInput) searchInput.value = '';
            pendingFilters = null;
            currentPage = 1;
            updateItemsPerPage();
            renderProducts();
            setupPagination();
        });

        document.addEventListener('change', (e) => {
            if (e.target.matches('.color-options input, .size-options input, .category-options input')) {
                storePendingFilters();
            }
        });

        document.querySelector('.pagination-button.prev').addEventListener('click', () => {
            if (currentPage > 1) {
                goToPage(currentPage - 1);
            }
        });

        document.querySelector('.pagination-button.next').addEventListener('click', () => {
            const filters = pendingFilters || getFilters();
            const filtered = products.filter(p => {
                const matchesColor = !filters.colors.length || (p.color && filters.colors.some(c => c.value === p.color.id.toString()));
                const matchesSize = !filters.sizes.length || (p.size && filters.sizes.some(s => s.value === p.size.id.toString()));
                const matchesCategory = !filters.categories.length || (p.Category && filters.categories.some(c => c.value === p.Category.id.toString()));
                const matchesPrice = filters.maxPrice >= 1000 || parseFloat(p.price) <= filters.maxPrice;

                if (filters.search) {
                    const searchTerm = filters.search.toLowerCase();
                    const matchesSearch = p.title.toLowerCase().includes(searchTerm) ||
                        (p.description && p.description.toLowerCase().includes(searchTerm));
                    return matchesColor && matchesSize && matchesCategory && matchesPrice && matchesSearch;
                }

                return matchesColor && matchesSize && matchesCategory && matchesPrice;
            });

            const totalPages = Math.ceil(filtered.length / itemsPerPage);
            if (currentPage < totalPages) {
                goToPage(currentPage + 1);
            }
        });

        window.addEventListener('resize', () => {
            updateItemsPerPage();
            renderProducts();
            setupPagination();
        });
    });

    // Export functions
    window.toggleMobileFilters = toggleMobileFilters;
    window.toggleFilters = toggleFilters;
    window.addToCart = addToCart;
    window.addToWishlist = addToWishlist;
    window.viewDetails = viewDetails;
    window.goToPage = goToPage;
    window.closeAuthModal = closeAuthModal;
</script>
{% endblock %}