<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product - E-commerce Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Global Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background-color: #f5f5f9;
        }

        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar {
            width: 250px;
            background: #ffffff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            position: fixed;
            height: 100%;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            padding: 20px;
            color: #333;
            font-size: 20px;
            font-weight: 600;
        }

        .logo i {
            font-size: 24px;
            margin-right: 10px;
            color: #6c5ce7;
        }

        .menu {
            margin-top: 30px;
        }

        .menu li {
            list-style: none;
            margin-bottom: 5px;
            padding: 10px 20px;
            position: relative;
        }

        .menu li a {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: #555;
            font-size: 15px;
            font-weight: 500;
        }

        .menu li a i {
            margin-right: 15px;
            font-size: 18px;
        }

        .menu li.active {
            background: #f0efff;
            border-left: 4px solid #6c5ce7;
        }

        .menu li.active a {
            color: #6c5ce7;
        }

        .menu li:hover {
            background: #f0efff;
            cursor: pointer;
        }

        .menu li:hover a {
            color: #6c5ce7;
        }

        /* Main Content Styles */
        .main-content {
            flex: 1;
            margin-left: 250px;
            transition: all 0.3s ease;
        }

        .top-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #ffffff;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 99;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: #f5f5f9;
            padding: 10px 15px;
            border-radius: 30px;
            width: 300px;
        }

        .search-box i {
            color: #888;
            margin-right: 10px;
        }

        .search-box input {
            border: none;
            outline: none;
            background: transparent;
            width: 100%;
            font-size: 14px;
        }

        .user-profile {
            display: flex;
            align-items: center;
        }

        .notifications {
            position: relative;
            margin-right: 20px;
            cursor: pointer;
        }

        .notifications i {
            font-size: 20px;
            color: #555;
        }

        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .user {
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .user img {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .user span {
            font-size: 14px;
            font-weight: 500;
            color: #555;
            margin-right: 5px;
        }

        .user i {
            font-size: 12px;
            color: #888;
        }

        /* Content Styles */
        .content {
            padding: 20px;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-header h1 {
            font-size: 24px;
            color: #333;
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #888;
        }

        .breadcrumb a {
            color: #6c5ce7;
            text-decoration: none;
        }

        .breadcrumb span {
            margin: 0 10px;
        }

        /* Tab Styles */
        .tab-container {
            background: #ffffff;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .tab-nav {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
        }

        .tab-nav button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            color: #666;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab-nav button.active {
            color: #6c5ce7;
            background: #ffffff;
        }

        .tab-nav button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: #6c5ce7;
        }

        .tab-nav button:hover {
            color: #6c5ce7;
        }

        .tab-content {
            padding: 30px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* Form Styles */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #6c5ce7;
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
        }

        .form-group textarea {
            height: 120px;
            resize: vertical;
        }

        .file-input-wrapper {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 60px;
            border: 2px dashed #ddd;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
            font-size: 14px;
            text-align: center;
        }

        .file-input-label:hover,
        .file-input-label.dragover {
            border-color: #6c5ce7;
            color: #6c5ce7;
            background-color: #f8f9ff;
        }

        .file-input-label i {
            margin-right: 10px;
            font-size: 18px;
        }

        .image-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .image-preview-item {
            position: relative;
            width: 100%;
            height: 150px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-preview-item .remove-image {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 25px;
            height: 25px;
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* Button Styles */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #6c5ce7;
            color: white;
        }

        .btn-primary:hover {
            background: #5649be;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #545b62;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }

        /* Card List Styles */
        .card-list {
            margin-top: 30px;
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            padding: 20px;
        }

        .card-list h3 {
            margin-top: 0;
            margin-bottom: 20px;
            color: #333;
            font-size: 18px;
            font-weight: 600;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .cards-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .card {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
            transition: all 0.3s ease;
            position: relative;
        }

        .card:hover {
            background: #f0f0f0;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .card .card-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card .card-text {
            font-size: 14px;
            color: #333;
            font-weight: 500;
        }

        .card .delete-btn {
            background: #ff4757;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s;
        }

        .card .delete-btn:hover {
            background: #ff3742;
            transform: scale(1.1);
        }

        /* Color Card Specific */
        .color-card .color-preview {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            border: 1px solid #ddd;
            display: inline-block;
        }

        /* Success Message */
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c3e6cb;
            display: none;
        }

        .success-message.show {
            display: block;
        }

        /* Responsive Styles */
        @media (max-width: 768px) {
            .main-content {
                margin-left: 0;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .tab-nav {
                overflow-x: auto;
            }

            .tab-nav button {
                min-width: 120px;
                flex: none;
            }

            .form-actions {
                flex-direction: column;
            }

            .cards-container {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (max-width: 480px) {
            .cards-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">
                <i class="fas fa-shopping-bag"></i>
                <span>ShopAdmin</span>
            </div>
            <ul class="menu">
                <li>
                    <a href="{% url 'Dashboard' %}">
                        <i class="fas fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li class="active">
                    <a href="{% url 'product' %}">
                        <i class="fas fa-box"></i>
                        <span>Products</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'orders' %}">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Orders</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'customers' %}">
                        <i class="fas fa-users"></i>
                        <span>Customers</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'messages' %}">
                        <i class="fas fa-envelope"></i>
                        <span>Messages</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'discounts' %}">
                        <i class="fas fa-tag"></i>
                        <span>Discounts</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'settings' %}">
                        <i class="fas fa-cog"></i>
                        <span>Settings</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'Logout' %}">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Top Navigation -->
            <div class="top-nav">
                <div class="search-box">
                </div>
                {% include "admin.html" %}
            </div>

            <!-- Page Content -->
            <div class="content">
                <div class="page-header">
                    <h1>إضافة منتج</h1>
                    <div class="breadcrumb">
                        <a href="{% url 'Dashboard' %}">Dashboard</a>
                        <span>/</span>
                        <a href="{% url 'product' %}">Products</a>
                        <span>/</span>
                        <span>Add Product</span>
                    </div>
                </div>

                <div class="success-message" id="successMessage">
                    <i class="fas fa-check-circle"></i> تم الحفظ بنجاح!
                </div>

                <div class="tab-container">
                    <div class="tab-nav">
                        <button class="tab-btn active" data-tab="product">
                            <i class="fas fa-box"></i> منتج
                        </button>
                        <button class="tab-btn" data-tab="category">
                            <i class="fas fa-folder"></i> الفئات
                        </button>
                        <button class="tab-btn" data-tab="colors">
                            <i class="fas fa-palette"></i> الألوان
                        </button>
                        <button class="tab-btn" data-tab="sizes">
                            <i class="fas fa-ruler"></i> المقاسات
                        </button>
                        <button class="tab-btn" data-tab="clothing-categories">
                            <i class="fas fa-tshirt"></i> تصنيفات الملابس
                        </button>
                    </div>

                    <div class="tab-content">
                        <!-- Product Tab -->
                        <div class="tab-pane active" id="product">
                            <form id="productForm" enctype="multipart/form-data">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="title">عنوان المنتج *</label>
                                        <input type="text" id="title" name="title" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="price">السعر *</label>
                                        <input type="number" id="price" name="price" step="0.01" min="0" required>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="old_price">السعر القديم</label>
                                        <input type="number" id="old_price" name="old_price" step="0.01" min="0">
                                    </div>
                                    <div class="form-group">
                                        <label for="discount">الخصم (%)</label>
                                        <input type="number" id="discount" name="discount" min="0" max="100">
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="stock">الكمية المتوفرة</label>
                                        <input type="number" id="stock" name="stock" min="0" value="1" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="Category">الفئة</label>
                                        <select id="Category" name="Category">
                                            <option value="">اختر الفئة</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="color">اللون</label>
                                        <select id="color" name="color">
                                            <option value="">اختر اللون</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label for="size">المقاس</label>
                                        <select id="size" name="size">
                                            <option value="">اختر المقاس</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="Clothing_Categories">تصنيف الملابس</label>
                                    <select id="Clothing_Categories" name="Clothing_Categories">
                                        <option value="">اختر تصنيف الملابس</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>صور المنتج</label>
                                    <div class="file-input-wrapper">
                                        <div class="file-input-container">
                                            <input type="file" name="image_1" class="file-input" accept="image/*" required>
                                            <div class="file-input-label" data-input="image_1">
                                                <i class="fas fa-cloud-upload-alt"></i>
                                                الصورة الأولى (مطلوبة)
                                            </div>
                                        </div>
                                        <div class="file-input-container">
                                            <input type="file" name="image_2" class="file-input" accept="image/*">
                                            <div class="file-input-label" data-input="image_2">
                                                <i class="fas fa-cloud-upload-alt"></i>
                                                الصورة الثانية (اختياري)
                                            </div>
                                        </div>
                                        <div class="file-input-container">
                                            <input type="file" name="image_3" class="file-input" accept="image/*">
                                            <div class="file-input-label" data-input="image_3">
                                                <i class="fas fa-cloud-upload-alt"></i>
                                                الصورة الثالثة (اختياري)
                                            </div>
                                        </div>
                                        <div class="file-input-container">
                                            <input type="file" name="image_4" class="file-input" accept="image/*">
                                            <div class="file-input-label" data-input="image_4">
                                                <i class="fas fa-cloud-upload-alt"></i>
                                                الصورة الرابعة (اختياري)
                                            </div>
                                        </div>
                                        <div class="image-preview"></div>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button type="button" class="btn btn-secondary">إلغاء</button>
                                    <button type="submit" class="btn btn-primary">
                                        <i class="fas fa-save"></i> حفظ المنتج
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- Category Tab -->
                        <div class="tab-pane" id="category">
                            <form id="categoryForm" enctype="multipart/form-data">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="category_name">اسم الفئة *</label>
                                        <input type="text" id="category_name" name="name" required>
                                    </div>
                                    <div class="form-group">
                                        <label for="category_slug">الرابط (Slug) *</label>
                                        <input type="text" id="category_slug" name="slug" required>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="category_description">الوصف</label>
                                    <textarea id="category_description" name="description" placeholder="وصف الفئة..."></textarea>
                                </div>

                                <div class="form-group">
                                    <label>صورة الفئة</label>
                                    <div class="file-input-wrapper">
                                        <input type="file" name="image" class="file-input" accept="image/*">
                                        <div class="file-input-label">
                                            <i class="fas fa-cloud-upload-alt"></i>
                                            اضغط لاختيار صورة الفئة أو اسحبها هنا
                                        </div>
                                        <div class="image-preview"></div>
                                    </div>
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-plus"></i> إضافة فئة
                                    </button>
                                </div>
                            </form>

                            <div class="card-list">
                                <h3>الفئات الحالية</h3>
                                <div class="cards-container" id="categoryList">
                                    <!-- Categories will be loaded here -->
                                </div>
                            </div>
                        </div>

                        <!-- Colors Tab -->
                        <div class="tab-pane" id="colors">
                            <form id="colorForm">
                                <div class="form-group">
                                    <label for="color_name">اسم اللون *</label>
                                    <input type="text" id="color_name" name="color" required placeholder="مثال: أحمر، أزرق، أخضر">
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-plus"></i> إضافة لون
                                    </button>
                                </div>
                            </form>

                            <div class="card-list">
                                <h3>الألوان الحالية</h3>
                                <div class="cards-container" id="colorList">
                                    <!-- Colors will be loaded here -->
                                </div>
                            </div>
                        </div>

                        <!-- Sizes Tab -->
                        <div class="tab-pane" id="sizes">
                            <form id="sizeForm">
                                <div class="form-group">
                                    <label for="size_name">اسم المقاس *</label>
                                    <input type="text" id="size_name" name="size" required placeholder="مثال: S, M, L, XL">
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-plus"></i> إضافة مقاس
                                    </button>
                                </div>
                            </form>

                            <div class="card-list">
                                <h3>المقاسات الحالية</h3>
                                <div class="cards-container" id="sizeList">
                                    <!-- Sizes will be loaded here -->
                                </div>
                            </div>
                        </div>

                        <!-- Clothing Categories Tab -->
                        <div class="tab-pane" id="clothing-categories">
                            <form id="clothingCategoryForm">
                                <div class="form-group">
                                    <label for="clothing_category_name">اسم تصنيف الملابس *</label>
                                    <input type="text" id="clothing_category_name" name="category" required placeholder="مثال: قمصان، بناطيل، فساتين">
                                </div>

                                <div class="form-actions">
                                    <button type="submit" class="btn btn-success">
                                        <i class="fas fa-plus"></i> إضافة تصنيف
                                    </button>
                                </div>
                            </form>

                            <div class="card-list">
                                <h3>تصنيفات الملابس الحالية</h3>
                                <div class="cards-container" id="clothingCategoryList">
                                    <!-- Clothing categories will be loaded here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // API Endpoints
        const endpoints = {
            product: "/api/admin-products/",
            color: "/api/colors/",
            size: "/api/sizes/",
            category: "/api/categories/",
            categoryProduct: "/api/category-products/",
            getColors: "/api/get_colors/",
            getSizes: "/api/get_sizes/",
            getCategories: "/api/get_categories/",
            getCategoryProducts: "/api/get_category_products/"
        };

        // Tab Functionality
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // Remove active class from all buttons and panes
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                
                // Add active class to clicked button and corresponding pane
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
                
                // Load data when tab is clicked
                if (btn.dataset.tab === 'category') {
                    loadCategories();
                } else if (btn.dataset.tab === 'colors') {
                    loadColors();
                } else if (btn.dataset.tab === 'sizes') {
                    loadSizes();
                } else if (btn.dataset.tab === 'clothing-categories') {
                    loadClothingCategories();
                }
            });
        });

        // Success Message Function
        function showSuccessMessage(message) {
            const successMsg = document.getElementById('successMessage');
            successMsg.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            successMsg.classList.add('show');
            setTimeout(() => {
                successMsg.classList.remove('show');
            }, 3000);
        }

        // Error Message Function
        function showErrorMessage(message) {
            alert(`❌ خطأ: ${message}`);
        }

        // Generic Form Handler
function handleForm(formId, endpoint, hasFile = false) {
    const form = document.getElementById(formId);
    if (!form) return;

    form.addEventListener("submit", function (e) {
        e.preventDefault();

        let submitData = new FormData(form);
        
        // Special handling for product form
        if (formId === 'productForm') {
            // Map frontend field names to backend expected names
            const mappedData = new FormData();
            
            // Basic fields
            mappedData.append('title', submitData.get('title') || '');
            mappedData.append('price', submitData.get('price') || '');
            mappedData.append('old_price', submitData.get('old_price') || '');
            mappedData.append('discount', submitData.get('discount') || '');
            mappedData.append('description', submitData.get('description') || '');
            mappedData.append('stock', submitData.get('stock') || '');
            
            // Foreign key fields - send as IDs only
            const colorId = submitData.get('color');
            const sizeId = submitData.get('size');
            const categoryId = submitData.get('Category');
            
            if (colorId) mappedData.append('color', colorId);
            if (sizeId) mappedData.append('size', sizeId);
            if (categoryId) mappedData.append('Category', categoryId);
            
            // Many-to-many field for clothing categories
            const clothingCategories = submitData.getAll('Clothing_Categories');
            if (clothingCategories.length > 0) {
                // Send as JSON string or individual append calls
                clothingCategories.forEach(catId => {
                    mappedData.append('clothing_categories_ids', catId);
                });
            }
            
            // Handle image files
            const imageFields = ['image_1', 'image_2', 'image_3', 'image_4'];
            imageFields.forEach(field => {
                const file = submitData.get(field);
                if (file && file.size > 0) {
                    mappedData.append(field, file);
                }
            });
            
            submitData = mappedData;
        }

        fetch(endpoint, {
            method: "POST",
            body: submitData,
            credentials: "include"
        })
        .then(res => {
            if (!res.ok) {
                return res.json().then(err => Promise.reject(err));
            }
            return res.json();
        })
        .then(data => {
            if (data.id) {
                showSuccessMessage("تم الإضافة بنجاح!");
                form.reset();
                
                // Clear image previews if applicable
                if (formId === 'productForm' || formId === 'categoryForm') {
                    const previewContainer = form.querySelector('.image-preview');
                    if (previewContainer) {
                        previewContainer.innerHTML = '';
                    }
                }
                
                // Refresh the appropriate list based on the form
                if (formId === 'categoryForm') {
                    loadCategories();
                } else if (formId === 'colorForm') {
                    loadColors();
                } else if (formId === 'sizeForm') {
                    loadSizes();
                } else if (formId === 'clothingCategoryForm') {
                    loadClothingCategories();
                }
                
                // Refresh dropdowns
                loadDropdownData();
            } else {
                showErrorMessage("خطأ في البيانات المرسلة");
            }
        })
        .catch(err => {
            console.error('Error:', err);
            showErrorMessage(err.message || JSON.stringify(err));
        });
    });
}


function handleProductFormWithJSON() {
    const form = document.getElementById('productForm');
    if (!form) return;

    form.addEventListener("submit", function (e) {
        e.preventDefault();

        const formData = new FormData(form);
        
        // Prepare JSON data for non-file fields
        const jsonData = {
            title: formData.get('title'),
            price: formData.get('price'),
            old_price: formData.get('old_price'),
            discount: formData.get('discount') || null,
            description: formData.get('description'),
            stock: formData.get('stock'),
            color: formData.get('color') ? parseInt(formData.get('color')) : null,
            size: formData.get('size') ? parseInt(formData.get('size')) : null,
            Category: formData.get('Category') ? parseInt(formData.get('Category')) : null,
            clothing_categories_ids: formData.getAll('Clothing_Categories').map(id => parseInt(id))
        };

        // Create new FormData for mixed content
        const submitData = new FormData();
        
        // Add JSON data
        submitData.append('data', JSON.stringify(jsonData));
        
        // Add image files
        const imageFields = ['image_1', 'image_2', 'image_3', 'image_4'];
        imageFields.forEach(field => {
            const file = formData.get(field);
            if (file && file.size > 0) {
                submitData.append(field, file);
            }
        });

        fetch('/api/admin-products/', {
            method: "POST",
            body: submitData,
            credentials: "include"
        })
        .then(res => {
            if (!res.ok) {
                return res.json().then(err => Promise.reject(err));
            }
            return res.json();
        })
        .then(data => {
            if (data.id) {
                showSuccessMessage("تم الإضافة بنجاح!");
                form.reset();
                
                const previewContainer = form.querySelector('.image-preview');
                if (previewContainer) {
                    previewContainer.innerHTML = '';
                }
                
                loadDropdownData();
            } else {
                showErrorMessage("خطأ في البيانات المرسلة");
            }
        })
        .catch(err => {
            console.error('Error:', err);
            showErrorMessage(err.message || JSON.stringify(err));
        });
    });
}
        async function loadDropdownData() {
            try {
                // Load Colors
                const colorsResponse = await fetch(endpoints.getColors);
                const colors = await colorsResponse.json();
                const colorSelect = document.getElementById('color');
                colorSelect.innerHTML = '<option value="">اختر اللون</option>';
                colors.forEach(color => {
                    colorSelect.innerHTML += `<option value="${color.id}">${color.color}</option>`;
                    console.log(`Loaded color: ${color.color} (ID: ${color.id})`);
                });

                // Load Sizes
                const sizesResponse = await fetch(endpoints.getSizes);
                const sizes = await sizesResponse.json();
                const sizeSelect = document.getElementById('size');
                sizeSelect.innerHTML = '<option value="">اختر المقاس</option>';
                sizes.forEach(size => {
                    sizeSelect.innerHTML += `<option value="${size.id}">${size.size}</option>`;
                });

                // Load Categories
                const categoriesResponse = await fetch(endpoints.getCategories);
                const categories = await categoriesResponse.json();
                const categorySelect = document.getElementById('Category');
                categorySelect.innerHTML = '<option value="">اختر الفئة</option>';
                categories.forEach(category => {
                    categorySelect.innerHTML += `<option value="${category.id}">${category.name}</option>`;
                });

                // Load Clothing Categories
                const clothingCategoriesResponse = await fetch(endpoints.getCategoryProducts);
                const clothingCategories = await clothingCategoriesResponse.json();
                const clothingCategorySelect = document.getElementById('Clothing_Categories');
                clothingCategorySelect.innerHTML = '<option value="">اختر تصنيف الملابس</option>';
                clothingCategories.forEach(category => {
                    clothingCategorySelect.innerHTML += `<option value="${category.id}">${category.category}</option>`;
                });

            } catch (error) {
                console.error('Error loading dropdown data:', error);
            }
        }

        // Load and display categories
        async function loadCategories() {
            try {
                const response = await fetch(endpoints.getCategories);
                const categories = await response.json();
                const container = document.getElementById('categoryList');
                container.innerHTML = '';
                
                categories.forEach(category => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-content">
                            <span class="card-text">${category.name}</span>
                            <button class="delete-btn" data-id="${category.id}" onclick="deleteItem('category', ${category.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        // Load and display colors
        async function loadColors() {
            try {
                const response = await fetch(endpoints.getColors);
                const colors = await response.json();
                const container = document.getElementById('colorList');
                container.innerHTML = '';
                console.log(getColorCode(color.color))
                colors.forEach(color => {
                    const card = document.createElement('div');
                    card.className = 'card color-card';
                    card.innerHTML = `
                        <div class="card-content">
                            <div>
                                <span class="color-preview" style="background-color: ${color.color}"></span>
                                <span class="card-text">${color.color}</span>
                            </div>
                            <button class="delete-btn" data-id="${color.id}" onclick="deleteItem('color', ${color.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading colors:', error);
            }
        }

        // Helper function to get color code from color name
        function getColorCode(colorName) {
            const colorMap = {
                'أحمر': '#ff0000',
                'أزرق': '#0000ff',
                'أخضر': '#00ff00',
                'أصفر': '#ffff00',
                'أسود': '#000000',
                'أبيض': '#ffffff',
                'رمادي': '#808080',
                'بني': '#a52a2a',
                'زهري': '#ffc0cb',
                'برتقالي': '#ffa500',
                'بنفسجي': '#800080'
            };
            
            return colorMap[colorName] || '#cccccc';
        }

        // Load and display sizes
        async function loadSizes() {
            try {
                const response = await fetch(endpoints.getSizes);
                const sizes = await response.json();
                const container = document.getElementById('sizeList');
                container.innerHTML = '';
                
                sizes.forEach(size => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-content">
                            <span class="card-text">${size.size}</span>
                            <button class="delete-btn" data-id="${size.id}" onclick="deleteItem('size', ${size.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading sizes:', error);
            }
        }

        // Load and display clothing categories
        async function loadClothingCategories() {
            try {
                const response = await fetch(endpoints.getCategoryProducts);
                const categories = await response.json();
                const container = document.getElementById('clothingCategoryList');
                container.innerHTML = '';
                
                categories.forEach(category => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <div class="card-content">
                            <span class="card-text">${category.category}</span>
                            <button class="delete-btn" data-id="${category.id}" onclick="deleteItem('clothing-category', ${category.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error loading clothing categories:', error);
            }
        }

        // Delete item function
        async function deleteItem(type, id) {
            if (!confirm('هل أنت متأكد أنك تريد حذف هذا العنصر؟')) return;
            
            let endpoint;
            switch(type) {
                case 'category':
                    endpoint = `${endpoints.category}${id}/`;
                    break;
                case 'color':
                    endpoint = `${endpoints.color}${id}/`;
                    break;
                case 'size':
                    endpoint = `${endpoints.size}${id}/`;
                    break;
                case 'clothing-category':
                    endpoint = `${endpoints.categoryProduct}${id}/`;
                    break;
                default:
                    return;
            }
            
            try {
                const response = await fetch(endpoint, {
                    method: 'DELETE',
                    credentials: 'include'
                });
                
                if (response.ok) {
                    showSuccessMessage('تم الحذف بنجاح!');
                    
                    // Refresh the appropriate list
                    switch(type) {
                        case 'category':
                            loadCategories();
                            break;
                        case 'color':
                            loadColors();
                            break;
                        case 'size':
                            loadSizes();
                            break;
                        case 'clothing-category':
                            loadClothingCategories();
                            break;
                    }
                    
                    // Refresh dropdowns
                    loadDropdownData();
                } else {
                    showErrorMessage('فشل في حذف العنصر');
                }
            } catch (error) {
                showErrorMessage('حدث خطأ في الاتصال: ' + error.message);
            }
        }

        // File Input Handler for Product and Category Images
        function setupFileInputs() {
            const fileInputContainers = document.querySelectorAll('.file-input-container');
            const categoryFileInput = document.querySelector('#categoryForm .file-input');
            const categoryFileLabel = document.querySelector('#categoryForm .file-input-label');
            const categoryPreviewContainer = document.querySelector('#categoryForm .image-preview');

            // Handle product image inputs
            fileInputContainers.forEach((container, index) => {
                const fileInput = container.querySelector('.file-input');
                const fileLabel = container.querySelector('.file-input-label');
                const previewContainer = container.parentElement.querySelector('.image-preview');

                // Click to trigger file input
                fileLabel.addEventListener('click', () => {
                    fileInput.click();
                });

                // Drag and drop
                fileLabel.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileLabel.classList.add('dragover');
                });

                fileLabel.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    fileLabel.classList.remove('dragover');
                });

                fileLabel.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileLabel.classList.remove('dragover');
                    const files = Array.from(e.dataTransfer.files);
                    if (files.length > 0) {
                        handleFileSelection(files[0], index, previewContainer, fileInput);
                    }
                });

                // File input change
                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleFileSelection(e.target.files[0], index, previewContainer, fileInput);
                    }
                });
            });

            // Handle category image input
            if (categoryFileInput && categoryFileLabel && categoryPreviewContainer) {
                categoryFileLabel.addEventListener('click', () => {
                    categoryFileInput.click();
                });

                categoryFileLabel.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    categoryFileLabel.classList.add('dragover');
                });

                categoryFileLabel.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    categoryFileLabel.classList.remove('dragover');
                });

                categoryFileLabel.addEventListener('drop', (e) => {
                    e.preventDefault();
                    categoryFileLabel.classList.remove('dragover');
                    const files = Array.from(e.dataTransfer.files);
                    if (files.length > 0) {
                        handleFileSelection(files[0], 0, categoryPreviewContainer, categoryFileInput);
                    }
                });

                categoryFileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        handleFileSelection(e.target.files[0], 0, categoryPreviewContainer, categoryFileInput);
                    }
                });
            }
        }

        // Handle file selection and preview
        function handleFileSelection(file, index, previewContainer, fileInput) {
            if (!file.type.startsWith('image/')) {
                showErrorMessage('يرجى اختيار ملف صورة صالح');
                return;
            }

            // Set file to input
            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;

            // Create preview
            const reader = new FileReader();
            reader.onload = (e) => {
                createImagePreview(e.target.result, index, previewContainer, fileInput.name);
            };
            reader.readAsDataURL(file);
        }

        // Create image preview
        function createImagePreview(src, index, container, inputName) {
            // Remove existing preview for this index
            const existingPreview = container.querySelector(`[data-index="${index}"]`);
            if (existingPreview) {
                existingPreview.remove();
            }

            const previewItem = document.createElement('div');
            previewItem.className = 'image-preview-item';
            previewItem.dataset.index = index;
            previewItem.innerHTML = `
                <img src="${src}" alt="Preview ${inputName}">
                <button type="button" class="remove-image" onclick="removeImage('${inputName}', ${index})">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(previewItem);
        }

        // Remove image preview and clear file input
        function removeImage(inputName, index) {
            const fileInput = document.querySelector(`input[name="${inputName}"]`);
            const previewContainer = fileInput.closest('.file-input-wrapper').querySelector('.image-preview');
            
            // Clear the file input
            if (fileInput) {
                fileInput.value = '';
            }
            
            // Remove preview
            const previewItem = previewContainer.querySelector(`[data-index="${index}"]`);
            if (previewItem) {
                previewItem.remove();
            }
        }

        // Auto-generate slug from category name
        function setupSlugGeneration() {
            const nameInput = document.getElementById('category_name');
            const slugInput = document.getElementById('category_slug');
            
            if (nameInput && slugInput) {
                nameInput.addEventListener('input', () => {
                    const slug = nameInput.value
                        .toLowerCase()
                        .replace(/[\u0600-\u06FF]/g, (match) => {
                            // Simple Arabic to English transliteration
                            const arabicToEnglish = {
                                'ا': 'a', 'ب': 'b', 'ت': 't', 'ث': 'th', 
                                'ج': 'j', 'ح': 'h', 'خ': 'kh', 'د': 'd',
                                'ذ': 'dh', 'ر': 'r', 'ز': 'z', 'س': 's',
                                'ش': 'sh', 'ص': 's', 'ض': 'd', 'ط': 't',
                                'ظ': 'z', 'ع': 'a', 'غ': 'gh', 'ف': 'f',
                                'ق': 'q', 'ك': 'k', 'ل': 'l', 'م': 'm',
                                'ن': 'n', 'ه': 'h', 'و': 'w', 'ي': 'y'
                            };
                            return arabicToEnglish[match] || match;
                        })
                        .replace(/[^a-z0-9]/g, '-')
                        .replace(/-+/g, '-')
                        .replace(/^-|-$/g, '');
                    
                    slugInput.value = slug;
                });
            }
        }

        // Calculate discount percentage
        function setupDiscountCalculation() {
            const priceInput = document.getElementById('price');
            const oldPriceInput = document.getElementById('old_price');
            const discountInput = document.getElementById('discount');
            
            function calculateDiscount() {
                const price = parseFloat(priceInput.value) || 0;
                const oldPrice = parseFloat(oldPriceInput.value) || 0;
                
                if (price > 0 && oldPrice > price) {
                    const discount = ((oldPrice - price) / oldPrice * 100).toFixed(0);
                    discountInput.value = discount;
                }
            }
            
            function calculatePrice() {
                const oldPrice = parseFloat(oldPriceInput.value) || 0;
                const discount = parseFloat(discountInput.value) || 0;
                
                if (oldPrice > 0 && discount > 0 && discount <= 100) {
                    const price = (oldPrice * (1 - discount / 100)).toFixed(2);
                    priceInput.value = price;
                }
            }
            
            if (priceInput && oldPriceInput && discountInput) {
                priceInput.addEventListener('input', calculateDiscount);
                oldPriceInput.addEventListener('input', calculateDiscount);
                discountInput.addEventListener('input', calculatePrice);
            }
        }

        // Form validation
        function validateProductForm() {
            const form = document.getElementById('productForm');
            const requiredFields = form.querySelectorAll('[required]');
            let isValid = true;
            
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.style.borderColor = '#ff4757';
                    isValid = false;
                } else {
                    field.style.borderColor = '#ddd';
                }
            });
            
            return isValid;
        }

        // Setup search functionality
        function setupSearch() {
            const searchInput = document.querySelector('.search-box input');
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    // Implement search functionality here if needed
                    console.log('Searching for:', searchTerm);
                });
            }
        }

        // Mobile menu toggle
        function setupMobileMenu() {
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');
            
            // Create mobile menu button
            const menuBtn = document.createElement('button');
            menuBtn.innerHTML = '<i class="fas fa-bars"></i>';
            menuBtn.className = 'mobile-menu-btn';
            menuBtn.style.cssText = `
                display: none;
                position: fixed;
                top: 20px;
                left: 20px;
                z-index: 101;
                background: #6c5ce7;
                color: white;
                border: none;
                padding: 10px;
                border-radius: 5px;
                cursor: pointer;
            `;
            
            document.body.appendChild(menuBtn);
            
            // Show menu button on mobile
            function checkScreenSize() {
                if (window.innerWidth <= 768) {
                    menuBtn.style.display = 'block';
                } else {
                    menuBtn.style.display = 'none';
                    sidebar.style.transform = 'translateX(0)';
                }
            }
            
            menuBtn.addEventListener('click', () => {
                const isOpen = sidebar.style.transform === 'translateX(0px)';
                sidebar.style.transform = isOpen ? 'translateX(-100%)' : 'translateX(0)';
            });
            
            window.addEventListener('resize', checkScreenSize);
            checkScreenSize();
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Setup form handlers
            handleForm('productForm', endpoints.product, true);
            handleForm('categoryForm', endpoints.category, true);
            handleForm('colorForm', endpoints.color);
            handleForm('sizeForm', endpoints.size);
            handleForm('clothingCategoryForm', endpoints.categoryProduct);
            
            // Setup other functionalities
            setupFileInputs();
            setupSlugGeneration();
            setupDiscountCalculation();
            setupSearch();
            setupMobileMenu();
            
            // Load initial data
            loadDropdownData();
            
            // Load data for the current tab
            const activeTab = document.querySelector('.tab-btn.active');
            if (activeTab) {
                const tabName = activeTab.dataset.tab;
                if (tabName === 'category') {
                    loadCategories();
                } else if (tabName === 'colors') {
                    loadColors();
                } else if (tabName === 'sizes') {
                    loadSizes();
                } else if (tabName === 'clothing-categories') {
                    loadClothingCategories();
                }
            }
        });

        // Add some utility functions
        
        // Format price display
        function formatPrice(price) {
            return new Intl.NumberFormat('ar-MA', {
                style: 'currency',
                currency: 'MAD'
            }).format(price);
        }
        
        // Debounce function for search
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        // Show loading state
        function showLoading(element) {
            if (element) {
                element.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري التحميل...';
                element.disabled = true;
            }
        }
        
        // Hide loading state
        function hideLoading(element, originalText) {
            if (element) {
                element.innerHTML = originalText;
                element.disabled = false;
            }
        }
    </script>
</body>
</html>